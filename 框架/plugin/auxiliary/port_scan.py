# @author:九世
# @time:2019/5/11
# @file:port_scan.py

import gevent
from gevent import monkey;monkey.patch_all()
import sys
import socket
import re
from multiprocessing import Process


sys.dont_write_bytecode=True

usage={}
options={}
options['RHOST']=''
options['RPORT']=''

usage['RHOST']='目标IP'
usage['RPORT']='扫描端口范围，例如:1-65535'

def init():
    jg={}
    jg['name']='port_scan'
    jg['time']='2019/5/11'
    jg['author']='jiushi'
    jg['fun']='端口扫描'
    return jg

def info():
    print('用于端口扫描')

def scan(host,port):
    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.settimeout(3)
    try:
        s.connect((host,int(port)))
        print('[+] 开放的端口:{}'.format(port))
    except:
        pass


def xc(rw):

    rpg=[]
    for u in rw:
        rpg.append(gevent.spawn(scan,options['RHOST'],u))

    gevent.joinall(rpg)

def run():
    tg=[]
    calc=0
    port_fan=re.findall('[1-9]\d*',options['RPORT'])
    print('[&] 目标IP:{}'.format(options['RHOST']))
    for p in range(int(port_fan[0]),int(port_fan[1])):
        if calc==5000:
            p=Process(target=xc,args=(tg,))
            p.start()
            calc=0
            tg.clear()
        calc += 1
        tg.append(p)
    if len(tg)>0:
        p = Process(target=xc, args=(tg,))
        p.start()
        p.join()